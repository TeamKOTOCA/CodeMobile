<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CodeMobile</title>
  <link rel="icon" href="./codemobile.png">
  <style>
  body {
    font-family: sans-serif;
    margin: 0;
    display: flex;
    flex-direction: column;

    background-color: #282c34;
    height: 100vh;
  }
  
  #menu_top{
    display: none;
    position: fixed;
    height: 100vh;
    width:100svw;
    top: 0;
    left: 0;
    background-color: #282c34;
    z-index: 99;
  }

  .head{
    height: 50px;
    display: flex;
    border: 1px solid #ccc;
    border-bottom: 1px solid #666;
  }
  .head button{
    background: none;
    border: none;
    border-radius: 0;
    padding: 0;
    cursor: pointer;
    z-index: 1000;
  }
  .head img{
    height: 50px;
  }

  #lang_selector{
    background-color: #282c34;
    border-radius: 0;
    font-size: 1.25em;
    color: #aaa;
  }

  .editor-container {
    position: relative;
    background-color: #282c34;
    border: 1px solid #ccc;
    border-top: 1px solid #666;
    font-family: monospace;
    flex-grow: 1;
    overflow: hidden;
  }

  .line-numbers {
    position: absolute;
    top: 0;
    left: 0;
    width: 50px;
    background: #1e1e1e;
    height: fit-content;
    overflow-y: scroll;
    scrollbar-width: none;
    color: #858585;
    padding: 10px;
    line-height: 1.5;
    text-align: right;
    user-select: none;
    box-sizing: border-box;
  }

  /* エディタとハイライト部分の見た目を完全一致させる */
  .highlighted-code,
  textarea#codeEditor {
    font-family: monospace;
    font-size: 14px;
    line-height: 1.5;
    letter-spacing: 0;
    padding: 10px 10px 10px 80px;
    margin: 0;
    box-sizing: border-box;
    white-space: pre-wrap;
    word-break: break-word;
    overflow-wrap: break-word;
  }

  /* ハイライト表示用 */
  .highlighted-code {
    color: #abb2bf;
    background: transparent;
    overflow-y: auto;
    height: 100%;
  }

  /* 実際の入力欄（透明） */
  textarea#codeEditor {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    color: transparent;
    caret-color: white;
    border: none;
    resize: none;
    z-index: 2;
  }

  /* ハイライト用クラス */
  .comment {
    color: #236108;
  }

  .string {
    color: #FFFFFF;
  }

  /* 補完リスト */
  #autocomplete-list {
    position: absolute;
    z-index: 1000;
    background-color: #333;
    color: #fff;
    border: 1px solid #555;
    max-height: 200px;
    overflow-y: auto;
    display: none;
    font-size: 14px;
    list-style: none;
    padding-left: 0;
  }

  #autocomplete-list li {
    padding: 5px 10px;
    cursor: pointer;
  }

  #autocomplete-list li:hover,
  #autocomplete-list li.active {
    background-color: #007bff;
  }

  </style>
</head>
<body>
  <div id="menu_top">
    
  </div>
  <div class="head">
    <button onclick="menu_openner();"><img src="./codemobile.png" alt="toplogo"></button>
    <select id="lang_selector" name="lang_selector" required>
      <option value="" disabled>マークアップ言語</option>
      <option value="js" selected>Javascript</option>
      <option value="css">CSS</option>
      <option value="html">HTML</option>
      <option value="rust">Rust</option>
    </select>
  </div>
  <div class="editor-container">
    <div class="line-numbers" id="lineNumbers"></div>
    <pre class="highlighted-code" id="highlightedCode"></pre>
    <textarea id="codeEditor" spellcheck="false"></textarea>
    <ul id="autocomplete-list"></ul>
  </div>
  <script>
  let isMenuOpen = false;
  function menu_openner(){
    if(isMenuOpen){
      document.getElementById("menu_top").style.display = "none";
      isMenuOpen = false;
    }else{
      document.getElementById("menu_top").style.display = "block";
      isMenuOpen = true;
    }
  }
  
  
    const editor = document.getElementById('codeEditor');
    const highlighted = document.getElementById('highlightedCode');
    const lineNumbers = document.getElementById('lineNumbers');
    const autocompleteList = document.getElementById('autocomplete-list');
    const storageKey = 'codeEditorContent';

    let wordlistData = {};
    let allWords = [];
    let activeSuggestion = -1;

    readwordlist("js");
    function readwordlist(lang){
      // 1. 前回のデータを初期化
      wordlistData = {};
      allWords = [];

      // 2. 既存のハイライトCSSを削除
      const styleSheet = document.styleSheets[0];
      for (let i = styleSheet.cssRules.length - 1; i >= 0; i--) {
        if (styleSheet.cssRules[i].selectorText && styleSheet.cssRules[i].selectorText.startsWith('.highlight-')) {
          styleSheet.deleteRule(i);
        }
      }

      fetch("./wordlists/" + lang + '.json')
      .then((res) => res.json())
      .then((data) => {
        wordlistData = data;
        const styleSheet = document.styleSheets[0];
        for (const group in wordlistData) {
          const groupWords = Object.keys(wordlistData[group]);
          allWords.push(...groupWords);
          for (const word of groupWords) {
            const cls = 'highlight-' + word.replace(/[^a-zA-Z0-9_]/g, '');
            styleSheet.insertRule(`.${cls} { color: ${wordlistData[group][word]}; }`, styleSheet.cssRules.length);
          }
        }
        allWords.sort();
        const saved = localStorage.getItem(storageKey);
        if (saved) editor.value = saved;
        updateEditor();
      });
    }

    document.getElementById("lang_selector").addEventListener("change", function() {
      const lang = this.value;
      readwordlist(lang);
    });


    function escapeHTML(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
    
    function highlightCode(code) {
      code = escapeHTML(code);
      console.log(code);
    
      // コメント or 文字列を一括で処理（コメント優先）
      code = code.replace(/(\/\/[^\n]*|\/\*[\s\S]*?\*\/)|(".*?"|'.*?')/g, (match, comment, string) => {
        if (string) {
          return `<span class="string">${string}</span>`;
        }else if (comment) {
          return `<span class="comment">${comment}</span>`;
        }
        return match;
      });
      
      // HTMLタグ・コメント部分をセグメント化して除外
      const segments = code.split(/(<[^>]+>|<span class="comment">[\s\S]*?<\/span>)/g);
    
      for (let i = 0; i < segments.length; i++) {
        // タグでもコメントでもない部分だけ
        if (!segments[i].startsWith('<') && !segments[i].includes('class="comment"')) {
          for (const group in wordlistData) {
            for (const word in wordlistData[group]) {
              const className = 'highlight-' + word.replace(/[^a-zA-Z0-9_]/g, '');
              const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              const regex = new RegExp(`\\b(${escapedWord})\\b`, 'g');
              segments[i] = segments[i].replace(regex, `<span class="${className}">$1</span>`);
            }
          }
        }
      }
    
      return segments.join('');
    }


    const updateEditor = () => {
      const content = editor.value;
      highlighted.innerHTML = highlightCode(content);
      localStorage.setItem(storageKey, content);
      lineNumbers.innerHTML = Array.from({ length: content.split('\n').length }, (_, i) => i + 1).join('<br>');
    };

    editor.addEventListener('input', () => {
      updateEditor();
      showAutocomplete();
    });

    editor.addEventListener('scroll', () => {
      highlighted.scrollTop = editor.scrollTop;
      lineNumbers.scrollTop = editor.scrollTop;
      highlighted.scrollLeft = editor.scrollLeft;
      console.log(highlighted.scrollTop + ")(" + lineNumbers.scrollTop);
    });

    editor.addEventListener('keydown', (e) => {
      if (autocompleteList.style.display === 'block') {
        const suggestions = autocompleteList.querySelectorAll('li');
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          activeSuggestion = (activeSuggestion + 1) % suggestions.length;
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          activeSuggestion = (activeSuggestion - 1 + suggestions.length) % suggestions.length;
        } else if (e.key === 'Enter') {
          if (activeSuggestion >= 0) {
            e.preventDefault();
            insertSuggestion(suggestions[activeSuggestion].textContent);
          }
        } else if (e.key === 'Escape') {
          hideAutocomplete();
        }

        suggestions.forEach((li, i) => {
          li.classList.toggle('active', i === activeSuggestion);
        });
      }
    });

    const showAutocomplete = () => {
      const cursor = editor.selectionStart;
      const textBefore = editor.value.slice(0, cursor);
      const match = textBefore.match(/\b(\w+)$/);
      const current = match ? match[1] : '';

      if (!current) {
        hideAutocomplete();
        return;
      }

      const matches = allWords.filter(word => word.startsWith(current)).slice(0, 10);
      if (matches.length === 0) {
        hideAutocomplete();
        return;
      }

      autocompleteList.innerHTML = '';
      matches.forEach(word => {
        const li = document.createElement('li');
        li.textContent = word;
        li.onclick = () => insertSuggestion(word);
        autocompleteList.appendChild(li);
      });

      const rect = editor.getBoundingClientRect();
      autocompleteList.style.top = rect.top + editor.scrollTop + 20 + 'px';
      autocompleteList.style.left = rect.left + 60 + 'px';
      autocompleteList.style.display = 'block';
      activeSuggestion = -1;
    };

    const hideAutocomplete = () => {
      autocompleteList.style.display = 'none';
    };

    const insertSuggestion = (word) => {
      const cursor = editor.selectionStart;
      const text = editor.value;
      const before = text.slice(0, cursor);
      const after = text.slice(cursor);
      const match = before.match(/\b(\w+)$/);
      if (!match) return;
      const start = cursor - match[1].length;
      editor.value = text.slice(0, start) + word + after;
      editor.selectionStart = editor.selectionEnd = start + word.length;
      editor.focus();
      updateEditor();
      hideAutocomplete();
    };
  </script>
</body>
</html>